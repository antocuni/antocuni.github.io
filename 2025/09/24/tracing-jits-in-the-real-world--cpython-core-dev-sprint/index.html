<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Antonio Cuni's blog">
      
      
      
        <link rel="canonical" href="https://antocuni.eu/2025/09/24/tracing-jits-in-the-real-world--cpython-core-dev-sprint/">
      
      
        <link rel="prev" href="../../../08/25/inside-cpythons-attribute-lookup/">
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../assets/logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.3">
    
    
      
        <title>Tracing JITs in the real world @ CPython Core Dev Sprint - Antonio Cuni's blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.d7758b05.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Z20FNJZ1GJ"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Z20FNJZ1GJ",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Z20FNJZ1GJ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tracing-jits-in-the-real-world-cpython-core-dev-sprint" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Antonio Cuni's blog" class="md-header__button md-logo" aria-label="Antonio Cuni's blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Antonio Cuni's blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tracing JITs in the real world @ CPython Core Dev Sprint
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="cyan" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Antonio Cuni's blog" class="md-nav__button md-logo" aria-label="Antonio Cuni's blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.svg" alt="logo">

    </a>
    Antonio Cuni's blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../feed_rss_updated.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RSS feed
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2012/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2011/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2011
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2010/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2010
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2009/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2009
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2008/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2008
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/post/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/talk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Talk
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tracing-jit-and-real-world-python" class="md-nav__link">
    <span class="md-ellipsis">
      Tracing JIT and real world Python
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracing JIT and real world Python">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aka-what-we-can-learn-from-pypy" class="md-nav__link">
    <span class="md-ellipsis">
      aka: what we can learn from PyPy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2025-09-24 00:00:00+00:00" class="md-ellipsis">Sep 24, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/post/">Post</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              15 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags">
    
      
      
      
        <a href="../../../../tags/#tag:c-api" class="md-tag">c-api</a>
      
    
      
      
      
        <a href="../../../../tags/#tag:cpython" class="md-tag">cpython</a>
      
    
      
      
      
        <a href="../../../../tags/#tag:jit" class="md-tag">jit</a>
      
    
      
      
      
        <a href="../../../../tags/#tag:pypy" class="md-tag">pypy</a>
      
    
      
      
      
        <a href="../../../../tags/#tag:slides" class="md-tag">slides</a>
      
    
  </nav>



<h1 id="tracing-jits-in-the-real-world-cpython-core-dev-sprint">Tracing JITs in the real world @ CPython Core Dev Sprint<a class="headerlink" href="#tracing-jits-in-the-real-world-cpython-core-dev-sprint" title="Permanent link">¶</a></h1>
<p><meta property="og:title" content="Tracing JITs in the real world @ CPython Core Dev Sprint">
<meta property="og:description" content="My experience at the CPython Core Dev Sprint">
<meta property="og:image" content="http://antocuni.eu/2025/09-tracing-jit-real-world-python/cpython-core-dev-sprint-2025-cambridge.jpg">
<meta name="author" content="Antonio Cuni"></p>
<style>
.slide {
  border: 2px solid #ddd;
  border-radius: 8px;
  margin: 2em 0;
  background: #f9f9f9;
  max-width: 100%;
  width: 100%;
  box-sizing: border-box;
  padding: 2em;
  background: white;
  border-radius: 6px 6px 0 0;
  border-bottom: 2px solid #eee;
  display: block;

  min-height: 400px;
  height: auto;
  overflow-y: auto;
  overflow-x: hidden;
}

.slide h1, .slide h2, .slide h3 {
  margin-top: 0;
  color: #333;
}
</style>

<p>Last week I got to take part in the CPython Core Developer Sprint in
Cambridge, hosted by ARM and brilliantly
<a href="https://www.linkedin.com/posts/diegor_yesterday-we-wrapped-up-thecpython-core-activity-7375230888177057792-GezI">organized by Diego Russo</a>
-- about ~50 core devs and guests were there, and I was excited to join as one
of the guests.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../09-tracing-jit-real-world-python/cpython-core-dev-sprint-2025-cambridge.jpg" data-title="CPython Core Dev Sprint 2025, ARM, Cambridge" data-desc-position="bottom"><img alt="CPython Core Dev Sprint 2025, ARM, Cambridge" src="../../../09-tracing-jit-real-world-python/cpython-core-dev-sprint-2025-cambridge.jpg"></a></p>
<p>I had three main areas of focus:</p>
<ul>
<li>
<p><strong>C API</strong>: this was a follow up of what we discussed at the
    <a href="../../../07/21/slides-for-my-europython-2025-talks/">C API summit at EuroPython</a>. The current
    C API is problematic, so we are exploring ideas for the development of
    <a href="https://github.com/py-ni">PyNI</a> (Python Native Interface), whose design
    will likely be heavily inspired by <a href="https://hpyproject.org/">HPy</a>. It's
    important to underline that this is just the beginning and the entire
    process will require multiple PEPs.</p>
</li>
<li>
<p><strong>fancycompleter</strong> This is a
    <a href="https://github.com/python/cpython/pull/130473">small PR</a> which I started
    <a href="../../../02/26/over-the-clouds-cpython-pyodide-and-spy/">months ago</a>, to enable colorful
    tab completions within the Python REPL. I wrote the original version of
    <a href="https://github.com/pdbpp/fancycompleter">fancycompleter</a> 15 years ago,
    but colorful completions work only in combination with PyREPL. Now PyREPL
    is part of the standard library and enabled by default, so we can finally
    upstream it. I hope to see it merged soon.</p>
</li>
<li>
<p>"<strong>JIT stuff</strong>": I spent a considerable amount of time talking to the
    people who are working on the CPython JIT (in particular Mark, Brandt,
    Savannah, Ken Jin and Diego). Knowledge transfer worked in both ways: I
    learned a lot about the internal details of CPython's JIT, and conversely I
    shared with them some of the experience, pain points and gut feelings
    which I got by working many years on PyPy.</p>
</li>
</ul>
<p>In particular, on the first day I presented a talk titled <strong>Tracing JIT and real world Python</strong> (<a href="../../../../talk/2025/09/core-dev-sprint-pypy-jit/">slides</a> and <a href="https://github.com/antocuni/antocuni.github.io/tree/main/blog/talk/2025/09/core-dev-sprint-pypy-jit">source code</a>).</p>
<p>What follows is an annotated version of the slides.</p>
<!-- more -->

<hr>
<div class="slide">
<h2 id="tracing-jit-and-real-world-python">Tracing JIT and real world Python<a class="headerlink" href="#tracing-jit-and-real-world-python" title="Permanent link">¶</a></h2>
<h3 id="aka-what-we-can-learn-from-pypy">aka: what we can learn from PyPy<a class="headerlink" href="#aka-what-we-can-learn-from-pypy" title="Permanent link">¶</a></h3>
</div>
<hr>
<div class="slide">
<h1 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">¶</a></h1>
<ul>
<li>
<p>CPython's JIT has a lot in common with PyPy</p>
</li>
<li>
<p>"Optimize for PyPy" ==&gt; my job for ~7 years</p>
</li>
<li>
<p>Real world code != pyperformance</p>
</li>
<li>
<p>Challenges &amp; lessons learned</p>
</li>
</ul>
</div>
<p>CPython's new JIT and PyPy's JIT share fundamental similarities, as they're both
tracing JITs.</p>
<p>I spent ~7 years of my career optimizing existing code for PyPy at a
high-frequency trading firm, and I realized that I'm probably one of the few
people in the world with actual experience in optimizing real world Python
code for a tracing JIT.</p>
<p>I expect that some of the challenges which I faced will still be valid also
for CPython, and I wanted to share my experience to make sure that CPython
core devs are aware of them.</p>
<p>One lesson which I learned is that the set of benchmarks in <code>pyperformance</code> are
a good starting point, but they are not entirely representative of what you
find in the wild.</p>
<p>The main goal of the talk is not to present <em>solutions</em> to these problems,
but to raise awareness that they exist.</p>
<hr>
<div class="slide">
<p>Assumption</p>
<ul>
<li>
<p>The JIT revolutionizes performance characteristics</p>
</li>
<li>
<p>CPython perf will look like PyPy's</p>
</li>
<li>
<p>==&gt; Some results are surprising</p>
</li>
</ul>
</div>
<p>Until now CPython's performance has been particularly predictable, there are
well established "performance tricks" to make code faster, and generally
speaking you can mostly reason about the speed of a given piece of code
"locally".</p>
<p>Adding a JIT completely changes how we reason about performance of a given
program, for two reasons:</p>
<ol>
<li>
<p>JITted code can be very fast if your code conforms to the heuristics
     applied by the JIT compiler, but unexpectedly slow(-ish) otherwise;</p>
</li>
<li>
<p>the speed of a given piece of code might depend heavily on what happens
     elsewhere in the program, making it much harder to reason about
     performance locally.</p>
</li>
</ol>
<p>The end result is that modifying a line of code can significantly
impact seemingly unrelated code. This effect becomes more pronounced as the
JIT becomes more sophisticated.</p>
<p>The CPython JIT is still pretty new and doesn’t give huge speedups yet. I
expect that as it gets faster, its performance will start looking more and
more like PyPy’s.</p>
<hr>
<div class="slide">
<h1 id="context">Context<a class="headerlink" href="#context" title="Permanent link">¶</a></h1>
<ul>
<li>
<p>High Frequency Trading firm (sport betting)</p>
</li>
<li>
<p>every ms counts</p>
</li>
<li>
<p>Python 2.7</p>
</li>
<li>
<p>Multi process system: stateful server + dispatcher + stateless workers (long-running processes)</p>
</li>
<li>
<p>"big" messages passed around</p>
</li>
</ul>
</div>
<hr>
<div class="slide">
<h2 id="pypy-jit-101">PyPy JIT 101<a class="headerlink" href="#pypy-jit-101" title="Permanent link">¶</a></h2>
<ul>
<li>
<p>Interpreter written in RPython</p>
</li>
<li>
<p>RPython -&gt; <code>*.c</code> -&gt; gcc -&gt; <code>./pypy</code></p>
</li>
<li>
<p>RPython -&gt; "jit codegen" -&gt; "jitcodes" (~RPython IR)</p>
</li>
<li>
<p>RPython jitcodes ~= CPython microops</p>
</li>
<li>
<p>Slightly higher level than C</p>
</li>
<li>
<p>Tracing means <em>executing jitcodes</em></p>
</li>
<li>
<p>we have an interpreter for that, super slow</p>
</li>
</ul>
</div>
<p>I delivered this talk at the Core Dev Sprint: I expected my audience to be
familiar with CPython's JIT, and wanted to draw parallels with PyPy's one.</p>
<p>Since the audience of this blog is different, let me <strong>briefly</strong> explain
CPython's JIT first.</p>
<p>The explanations of both JITs are necessarily short, incomplete and highly
simplified.</p>
<h4 id="cpython-jit-101">CPython JIT 101<a class="headerlink" href="#cpython-jit-101" title="Permanent link">¶</a></h4>
<p>Python source code is turned into bytecode. Bytecode is a sequence of
"opcodes" (<code>LOAD_FAST</code>, <code>BINARY_OP</code>, etc.), and the CPython VM is an
interpreter for those opcodes. Historically the VM was written by hand, and the
main loop consisted of a big <code>switch</code> statement which executed the code
corresponding to each opcode.</p>
<p>Nowadays things are different: the opcodes are written in a special DSL and
the main interpreter loop is generated from this
DSL. Additionally, the DSL describes how each opcode can be decomposed into
multiple "microops".</p>
<p>When the interpreter detects a "hot loop", it starts the JIT. The JIT
retroactively looks at the opcodes which were executed in the last iteration
of the loop, and creates a "linear trace" which contains the equivalent
microops. This process is called <strong>trace projection</strong> and the result is an
unoptimized trace of microops.</p>
<p>Then, the JIT can produce an optimized trace, by reordering and removing
redundant microops. Finally, the optimized trace is turned into executable
code using the "copy &amp; patch" technique.</p>
<h4 id="pypy-jit-101_1">PyPy JIT 101<a class="headerlink" href="#pypy-jit-101_1" title="Permanent link">¶</a></h4>
<p>CPython's Python interpreter is written in C, and then compiled into an
executable by <code>gcc</code> (or any other C compiler).</p>
<p>Similarly, PyPy's Python interpreter is written in RPython, and then compiled
into an executable by <code>rpython</code>.</p>
<p>Under the hood, <code>rpython</code> applies two separate transformations to the source
code:</p>
<ul>
<li>
<p>it turns each function into C code, which is then fed to <code>gcc</code> to get the
    final executable;</p>
</li>
<li>
<p>it turns each function into "jitcodes", which is a way to represent
    RPython's IR (internal representation). For each RPython function, the
    final <code>./pypy</code> executable contains its compiled representation (generated
    by GCC) <strong>and</strong> its jitcode representation (embedded as static data into the
    executable).</p>
</li>
</ul>
<p>In a way, RPython's jitcodes are equivalent to CPython's microops, as they are
a low-level representation of the logic of each opcode.</p>
<p>When the interpreter detects a hot loop, it enters <strong>trace recording</strong> mode,
which is essentially an interpreter which executes the jitcodes: the result is
a linear unoptimized trace of all the jitcodes which were actually executed.</p>
<p>Similarly to CPython, PyPy then produces an optimized trace, which is then
sent to the JIT backend for actual native code generation.</p>
<hr>
<div class="slide">
<h3 id="problem-1-trace-blockers">Problem 1: trace blockers<a class="headerlink" href="#problem-1-trace-blockers" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_pi</span><span class="p">():</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Compute an approximation of PI using the Leibniz series</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    """</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.0000001</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">pi_approx</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">term</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Initial term to enter the loop</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>            <span class="n">term</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="n">term</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">pi_approx</span> <span class="o">=</span> <span class="n">pi_approx</span> <span class="o">+</span> <span class="n">term</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi_approx</span>
</code></pre></div>
</div>
<p>Tracing JITs work by recording a trace of all microops which are
executed. The optimizer can then reason about what happens in the trace and
remove unneeded operations.</p>
<p>However, sometimes we encounter some operation which is a black box from the
point of view of the tracer: we call them "trace blocker", because the tracing
JIT cannot see through them.  In the case of CPython, this happens for
example, whenever we call any function implemented in C (because it doesn't
have any correspondent "microop").</p>
<p>This is a simple function that computes <code>pi</code>, generated by ChatGPT.  Its
precise content is not important: what matters is that it's a nice purely
numerical loop that the PyPy JIT can optimize very well.</p>
<hr>
<div class="slide">
<h3 id="problem-1-trace-blockers_1">Problem 1: trace blockers<a class="headerlink" href="#problem-1-trace-blockers_1" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_pi</span><span class="p">():</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="sd">    Compute an approximation of PI using the Leibniz series</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="sd">    """</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.0000001</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="n">pi_approx</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">term</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Initial term to enter the loop</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>            <span class="n">term</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>            <span class="n">term</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">pi_approx</span> <span class="o">=</span> <span class="n">pi_approx</span> <span class="o">+</span> <span class="n">term</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="n">hic_sunt_leones</span><span class="p">()</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; the JIT cannot enter here</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi_approx</span>
</code></pre></div>
</div>
<p>Same function as above, with a call to <code>hic_sunt_leones()</code>. This is actually
an <strong>empty function</strong> which does absolutely nothing, but annotated in a
special way so that the PyPy JIT cannot "enter" it, so it effectively behaves
as trace blocker.</p>
<hr>
<div class="slide">
<h2 id="hic-sunt-leones">Hic sunt leones<a class="headerlink" href="#hic-sunt-leones" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">empty</span><span class="p">():</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="k">pass</span>      <span class="c1"># the JIT cannot enter here</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">hic_sunt_leones</span><span class="p">():</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">pypyjit</span><span class="o">.</span><span class="n">residual_call</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>
<p>Any call to non-traceable function</p>
</li>
<li>
<p>C builtins, C extensions</p>
</li>
<li>
<p>(for PyPy): RPython instructions not understood by the JIT</p>
</li>
</ul>
</div>
<p>In this example we use the special <code>pypyjit.residual_call</code> to simulate a trace
blocker, but in real life we get it whenever we have a call to any
non-traceable function, in particular C extensions.</p>
<hr>
<div class="slide">
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>❯ python3.13 pi.py
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>2.1712 secs, pi = 3.1415928535897395
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>❯ pypy pi.py
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>0.0518 secs, pi = 3.1415928535897395
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>❯ # with "hic_sunt_leones()"
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>❯ pypy pi.py
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>1.1808 secs, pi = 3.1415928535897395
</code></pre></div>
</div>
<p>The clean version runs 42x faster on PyPy than CPython - that's the JIT
working perfectly. But with just one untraceable function call added to the
loop, PyPy slows down to only 1.8x faster than CPython. That single line
destroyed most of the JIT's effectiveness!</p>
<p>This happens because after the call the optimizer no longer knows whether its
assumptions about the world are still true, and thus must be much more
conservative.</p>
<p>I fear that for CPython, this will turn out to be a much bigger problem than
for PyPy, for two reasons:</p>
<ol>
<li>
<p>nowadays it's virtually impossible to run Python code without
     using any C extension, either directly or indirectly.</p>
</li>
<li>
<p>by construction, PyPy's JIT can see much more than CPython's
     JIT. Remember the slide about "jitcodes": any RPython function gets a
     "jitcodes" equivalent, which means that the JIT can automatially trace
     inside builtins and internals of the interpreter, whereas CPython can
     trace only inside pure python code.</p>
</li>
</ol>
<p>For example, PyPy's JIT can trace through <code>range()</code>, <code>zip</code>, and <code>enumerate()</code>
automatically. CPython's JIT currently cannot because they are implemented in
C. CPython <em>could</em> add special cases for these common functions, but the
general approach doesn't scale.</p>
<hr>
<div class="slide">
<h3 id="problem-2-data-driven-control-flow">Problem 2: data driven control flow<a class="headerlink" href="#problem-2-data-driven-control-flow" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">fn</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="s2">"Random nonsense computation generated by ChatGPT"</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">1.25</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.75</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">f</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">return</span> <span class="n">y</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DATA</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="n">acc</span> <span class="o">+=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The second big problem is what I call "data driven control flow". This example
has been autogenerated by ChatGPT and it's completely silly, but it's a good
representation of what happens in real life code.</p>
<p>In this example, <code>fn</code> takes 9 variables, each of them can be <code>None</code> or a
number. The function starts with a sequence of <code>if &lt;var&gt; is None: ...</code>. The
function is then called repeatedly in a loop.</p>
<p>One of the assumption of tracing JITs is that control flow tends to stay on
the "hot path", and that it's enough to optimize that to get good performance.</p>
<p>But in a case like this, each combination of <code>None</code>ness selects a different
path, and if we assume the data is evenly distributed, we find out that
<strong>there is no hot path</strong>.</p>
<p>Let's see what happens when we execute on CPython and PyPy:</p>
<hr>
<div class="slide">
<h3 id="problem-2-data-driven-control-flow_1">Problem 2: data driven control flow<a class="headerlink" href="#problem-2-data-driven-control-flow_1" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>❯ python3.13 data_driven.py
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>0.1274 secs
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>❯ pypy --jit off data_driven.py
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>0.2953 secs
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>❯ pypy data_driven.py
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>1.6414 secs
</code></pre></div>
</div>
<p>PyPy without JIT is "only" 2.3x slower than CPython, but when we enable the
JIT, it becomes <strong>much worse</strong>. This happens because of an exponential
explosion of code paths seen by the JIT.</p>
<p>In a normal compiler, an <code>if</code> statement is compiled as a diamond, and the
control flow merges after each <code>if</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>        if a is None
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>          /   \
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>         /     \
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>      a = 0    pass
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>         \     /
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>          \   /
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        if b is None
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>          /   \
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>         /     \
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>      b = 0    pass
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>         \     /
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>          \   /
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>           ...
</code></pre></div>
<p>A tracing JIT by definition follows what's happening during a concrete
execution, so it sees only a concrete path in the control flow, with "guards"
to ensure correctness:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>        guard(a is None)
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>          /
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>         /
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>      a = 0
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>         \
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>          \
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>   guard(b not None)
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>          /
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>         /
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>      b = 0
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>         \
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>          \
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>          ...
</code></pre></div>
<p>When <code>guard(a is None)</code> fails enough times, we create a "bridge" and record
another linear trace, following again the <em>concrete control flow</em> that happens
now:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>          guard(a is None) ----&gt; FAIL (side exit)
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>            /                         \
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>           /                           \
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        a = 0                          pass
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>           \                             \
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>            \                             \
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    guard(b not None)              guard(b not None)
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>            /                             /
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>           /                             /
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        b = 0                         b = 0
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>           \                             \
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>            \                             \
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>           ...                           ...
</code></pre></div>
<p>Note how <code>b = 0</code> is effectively duplicated now. By design, PyPy's JIT <em>never
merges execution flow</em>.</p>
<hr>
<div class="slide">
<h2 id="exponential-tracing">Exponential tracing<a class="headerlink" href="#exponential-tracing" title="Permanent link">¶</a></h2>
<ul>
<li>Every combination of "<code>None</code>ness" must be compiled separately</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>❯ PYPYLOG=jit-summary:- pypy data_driven.py
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>1.6387 secs
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>[a625ea04910] {jit-summary
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>...
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>Total # of loops:   11
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>Total # of bridges: 527
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>...
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>[a625ea507bc] jit-summary}
</code></pre></div>
</div>
<p>Looking inside <code>PYPYLOG</code> confirms our theory: we get "exponential
tracing". The JIT has to compile separate optimized code for every unique
combination of which parameters are None and which aren't. With 9 parameters,
that could be up to 512 different combinations!</p>
<hr>
<div class="slide">
<h2 id="exponential-tracing_1">Exponential tracing<a class="headerlink" href="#exponential-tracing_1" title="Permanent link">¶</a></h2>
<ul>
<li>Mitigation: branchless code</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>if x &lt; 0:
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>   x = 100
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a># ===&gt;
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>x = (x &lt; 0)*100 + (x &gt;= 0)*x
</code></pre></div>
<ul>
<li>
<p>Ugly, unreadable, not always possible</p>
</li>
<li>
<p>Never found a good solution</p>
</li>
<li>
<p>Happens quite a lot</p>
</li>
<li>
<p><em>Fundamental problem of tracing JITs</em>?</p>
</li>
</ul>
</div>
<p>One possible mitigation is to rewrite conditional code to be "branchless" -
using arithmetic tricks instead of if statements. But this makes code ugly and
unreadable, and it's not always possible.</p>
<p>Despite years of working on this, I never found a really good solution. There
were cases in which we had to continue running some piece of code on CPython
because I never managed to make the PyPy version faster.</p>
<p>This pattern happens quite a lot, although often is more subtle: in this silly
example all the <code>if</code>s are nicely grouped together at the start, but in a long
trace they can be scattered in multiple places, and <em>any</em> kind of control flow
contributes to the problem, not only <code>if</code>s. In Python, this includes any kind
of dynamic dispatch, exceptions, etc.</p>
<p>One possible solution for CPython's JIT is to try to merge (some) traces to
avoid or limit the exponential explosion. However, it is worth underlining that
tracing JITs shine precisely when they can optimize a long linear trace: if
you try to compile shorter traces, you might quickly end up in a situation
which is equivalent to the "trace blocker" problem described earlier.</p>
<p>I suspect this might be a fundamental limitation of tracing JITs.</p>
<hr>
<div class="slide">
<h3 id="problem-3-generators-and-async">Problem 3: generators (and async?)<a class="headerlink" href="#problem-3-generators-and-async" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_triples_loop</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="sd">    Counts how many integer right triangles (Pythagorean triples) have perimeter &lt;= P.</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="sd">    """</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">m_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">P</span><span class="p">))</span>  <span class="c1"># loose but safe upper bound for m</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>                <span class="n">p0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># a+b+c</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>                <span class="k">if</span> <span class="n">p0</span> <span class="o">&gt;</span> <span class="n">P</span><span class="p">:</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>                    <span class="k">continue</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>                <span class="n">count</span> <span class="o">+=</span> <span class="n">P</span> <span class="o">//</span> <span class="n">p0</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="k">return</span> <span class="n">count</span>
</code></pre></div>
</div>
<p>Compared to the other two problems, this is less serious, but it's worth
mentioning because of prevalence of <code>async</code> (and thus implicitly generators)
in modern Python.</p>
<p>Here's another silly function that counts Pythagorean triples using nested
loops. This is our baseline version using plain loops.</p>
<hr>
<div class="slide">
<h3 id="problem-3-generators-and-async_1">Problem 3: generators (and async?)<a class="headerlink" href="#problem-3-generators-and-async_1" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">range_product</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">):</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">):</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>            <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_triples_gen</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">m_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">math</span><span class="o">.</span><span class="n">isqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">P</span><span class="p">)))</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">range_product</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">m_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>            <span class="n">p0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># a+b+c</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>            <span class="k">if</span> <span class="n">p0</span> <span class="o">&gt;</span> <span class="n">P</span><span class="p">:</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>                <span class="k">continue</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>            <span class="n">count</span> <span class="o">+=</span> <span class="n">P</span> <span class="o">//</span> <span class="n">p0</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="k">return</span> <span class="n">count</span>
</code></pre></div>
</div>
<p>Here's the same algorithm refactored to use a generator function for the
nested iteration. The "state of iteration" is implicitly stored inside the
local variables of frame object associated to the <code>range_product</code> generator.</p>
<hr>
<div class="slide">
<h3 id="problem-3-generators-and-async_2">Problem 3: generators (and async?)<a class="headerlink" href="#problem-3-generators-and-async_2" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RangeProductIter</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">a</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">b</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">)</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
</div>
<p>Here's the same functionality implemented as a traditional iterator class. The
"state of iteration" is explicitly stored as attributes of <code>RangeProductIter</code>.</p>
<hr>
<div class="slide">
<h3 id="problem-3-generators-and-async_3">Problem 3: generators (and async?)<a class="headerlink" href="#problem-3-generators-and-async_3" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>❯ python3.13 pythagorean.py
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>loop: 0.4560 secs (1x)
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>gen:  0.5884 secs (1.29x)
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>iter: 1.0126 secs (2.22x)
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>❯ pypy pythagorean.py
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>loop: 0.1199 secs (1x)
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>gen:  0.1550 secs (1.29x)
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>iter: 0.1264 secs (1.05x)
</code></pre></div>
<ul>
<li>
<p>Generators force to create a frame</p>
</li>
<li>
<p>The JIT cannot see "through" generators</p>
</li>
<li>
<p>In real code, much worse slowdowns</p>
</li>
</ul>
</div>
<p>On CPython, the generator version is ~29% slower than the explicit loops. The
iterator class is much slower, as one would intuitively expect.</p>
<p>However, on PyPy we see different results: <code>RangeProductIter</code> is basically
same speed as the baseline, while the generator version is slower. This
happens because in the case of <code>RangeProductIter</code> the JIT is able to see the whole
lifetime of the object and optimize it away entirely: instance variables
become local variables, the call to <code>__next__</code> is inlined and we get the
equivalent of explicit nested loops.</p>
<p>However, generators are <em>required</em> to create a frame object and represent a
fundamental case in which the JIT cannot trace through them effectively. In
more complex real-world scenarios, we saw much worse slowdowns than these
examples show.</p>
<hr>
<div class="slide">
<h2 id="other-misc-problems">Other misc problems<a class="headerlink" href="#other-misc-problems" title="Permanent link">¶</a></h2>
<ul>
<li>
<p>Tooling, profilers</p>
</li>
<li>
<p>Warmup</p>
</li>
<li>
<p>Performance instability</p>
<ul>
<li><a href="https://arxiv.org/abs/1602.00602">Virtual Machine Warmup Blows Hot and Cold</a> (paper)</li>
</ul>
</li>
<li>
<p>Long tail of jitting</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>for n in itertools.count():
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>   job = accept_job()
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>   do(job)
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>   if n &gt; 12345:
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>       pypyjit.disable()
</code></pre></div>
</li>
</ul>
</div>
<p>This is a collection of other miscellaneous problems that I had to deal with. Generally
speaking, we lack good support for tooling and profilers. CPython needs to
have a good story to explain people how to understand what's happening when
the JIT is enabled.</p>
<p>Warmup is another big problem: in PyPy, very short programs tend to be slower
than CPython because JITting costs. Moreover warmup is not an easily definable
phase, as the linked paper shows.  This is an area where currently CPython
shines, as its JIT is very fast.  I think that it will become slightly slower
when it tries to optimize more aggressively, but hopefully warmup will
overall be a lesser problem than on PyPy.</p>
<p>Moreover, it's very easy to accidentally make your code 2x, 5x or even 10x
slower by changing seemingly innocent pieces of code. This is another reason
why good tooling is essential.</p>
<p>Finally, the "long tail of JITting": every loop and every guard gets a
counter, and we start JITting when it reaches a threshold. Given a
sufficiently long running program, all counters reach the threshold eventually
and we end up JITting much more than necessary, using too much memory and/or
thrashing the cache. In many cases I found beneficial to just disable the JIT
"after a while", with manually tuned heuristics.</p>
<hr>
<div class="slide">
<h2 id="bonus-slides">Bonus slides<a class="headerlink" href="#bonus-slides" title="Permanent link">¶</a></h2>
<h3 id="avoid-allocations-is-all-your-need">(Avoid) allocations is all your need<a class="headerlink" href="#avoid-allocations-is-all-your-need" title="Permanent link">¶</a></h3>
</div>
<p>These are slides which I didn't show during the live presentation, and show a
case where a tracing JIT can shine: since the JIT sees a complete trace of an
entire loop (including nested calls) it can easily removes a lot of temporary
objects which usually penalize Python performance.</p>
<p>In many cases, we can get the famous "zero-cost abstractions".</p>
<hr>
<div class="slide">
<h3 id="task">Task<a class="headerlink" href="#task" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>Compute center of gravity of a series of triangles serialized according to a binary
  protocol</p>
</li>
<li>
<p>Simulate protobuf, capnproto, etc.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Point</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">};</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Triangle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="p">};</span>
</code></pre></div>
</div>
<p>Let's look at a concrete example. We need to compute the barycenter of
triangles that are serialized in a binary format. Each triangle has three
points, each point has x and y coordinates. This simulates real world
protocols such as protobuf, capnproto, etc.</p>
<hr>
<div class="slide">
<h3 id="bare-loop">Bare loop<a class="headerlink" href="#bare-loop" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_loop</span><span class="p">():</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">'dddddd'</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="n">tot_x</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="n">tot_y</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'poly.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>            <span class="n">buf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>                <span class="k">break</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>            <span class="n">points</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>            <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">points</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>            <span class="n">tot_x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ax</span> <span class="o">+</span> <span class="n">bx</span> <span class="o">+</span> <span class="n">cx</span><span class="p">)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>            <span class="n">tot_y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ay</span> <span class="o">+</span> <span class="n">by</span> <span class="o">+</span> <span class="n">cy</span><span class="p">)</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">tot_x</span><span class="o">/</span><span class="n">n</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">tot_y</span><span class="o">/</span><span class="n">n</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div>
</div>
<p>This is what we use a a baseline: a bare loop, using <code>struct.unpack_from</code> to read 6 floats at a time.</p>
<hr>
<div class="slide">
<h3 id="schema-aware-protocol">Schema-aware protocol<a class="headerlink" href="#schema-aware-protocol" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Triangle</span><span class="p">:</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="nd">@property</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">Point</span><span class="p">:</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>    <span class="nd">@property</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s1">'d'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
</div>
<p>Here's the "proper" object-oriented approach, similar to how modern
serialization libraries work. We create <code>Triangle</code> and <code>Point</code> classes that
provide a nice API for accessing the binary data. Each property access creates
new objects and calls struct.unpack_from. This is much more readable and
reusable, but creates many temporary objects.</p>
<hr>
<div class="slide">
<h3 id="schema-aware-protocol_1">Schema-aware protocol<a class="headerlink" href="#schema-aware-protocol_1" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>            <span class="n">buf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>                <span class="k">break</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">Triangle</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>            <span class="n">tot_x</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>            <span class="n">tot_y</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>Here's how you'd use the object-oriented API. The code is much cleaner and
more readable than the bare loop version. But notice how many object creations
are happening: one <code>Triangle</code> object, six <code>Point</code> objects, plus all the
intermediate tuples from <code>struct.unpack_from</code>.</p>
<hr>
<div class="slide">
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>❯ python3.13 readpoly.py
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>read_loop:     0.5444 secs
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>read_proto:    3.0307 secs
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>❯ pypy readpoly.py
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>read_loop:     0.2945 secs
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>read_proto:    0.1183 secs
</code></pre></div>
</div>
<p>As expected, on CPython <code>read_proto</code> is much slower than the bare one,
roughly 6x slower. However, PyPy can fully optimize away all the
abstraction overhead introduced by <code>Triangle</code> and <code>Point</code>.</p>
<p>In PyPy jargon we call this form of allocation removal "virtuals" (because we
create "virtual objects" whose fields are represented as local variables) and
it's probably the single most important optimization that PyPy does.</p>
<p>During my week in Cambridge I talked extensively with the CPython JIT devs
about this and I hope I convinced them that this is what they should aim for
😊.</p>
<p>Note also that <code>read_proto</code> is actually <strong>faster</strong> than <code>read_loop</code>. This
happens because in <code>read_loop</code> we do a single <code>struct.unpack_from('dddddd', ...)</code>,
while in <code>read_proto</code> we do a succession of six individual
<code>struct.unpack_from('d', ...)</code>. It turns out that the JIT is able to trace
into the second form but not into the first, which means that in <code>read_loop</code>
we actually need to allocate a pseudo-tuple at each iteration.</p>
<p>The funny part is that <strong>I did not expect</strong> to get this result. I had to take
the time to analyze the JIT traces of both versions to understand why
<code>read_loop</code> was slower.  This is probably the best explanation of how
counterintuitive it is to reason about performance in a JITted world.</p>
<h2 id="acknowledgments">Acknowledgments<a class="headerlink" href="#acknowledgments" title="Permanent link">¶</a></h2>
<p>Thanks to <a href="https://cfbolz.de/">Carl Friedrich Bolz-Tereick</a> and
<a href="https://github.com/hoodmane">Hood Chatham</a> for feedback on the slides and the
post.</p>







  
  



  


  



<h2 id="__comments">Comments</h2>

<script src="https://giscus.app/client.js" data-repo="antocuni/antocuni.github.io" data-repo-id="R_kgDON3STLg" data-category="Announcements" data-category-id="DIC_kwDON3STLs4Cm2EZ" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2008 - 2025 Antonio Cuni  - <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="feed_rss_updated.xml" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/antocuni/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://mastodon.social/@antocuni" target="_blank" rel="noopener me" title="mastodon.social" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.5 102.5 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5m-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://bsky.app/profile/antocuni.bsky.social" target="_blank" rel="noopener" title="bsky.app" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2 42.1-31.6 110.3-56 110.3 21.8 0 15.5-8.9 130.5-14.1 149.2-18.2 64.8-84.4 81.4-143.3 71.3C456 322 482.2 380 425.6 438c-107.4 110.2-154.3-27.6-166.3-62.9-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8c-12 35.3-59 173.1-166.3 62.9-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1 10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/antocuni" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings">
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.sections", "navigation.indexes", "navigation.top", "search.highlight", "search.suggest", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>